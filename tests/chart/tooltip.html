<!DOCTYPE html>
<html>
    <head>
        <title>kendo.chart</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <link href="../qunit/qunit/qunit.css" type="text/css" rel="stylesheet"/>
    </head>
    <body>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.dataviz.core.js"></script>
        <script src="../../src/kendo.dataviz.chart.js"></script>
        <script src="../../src/kendo.dataviz.themes.js"></script>
        <script src="../../src/kendo.dataviz.svg.js"></script>
        <script src="../../src/kendo.dataviz.vml.js"></script>
        <script type="text/javascript">
            var dataviz = kendo.dataviz,
                TOLERANCE = 1;

            (function() {
                var tooltip,
                    element,
                    dataPointMock,
                    RED = "rgb(255,0,0)",
                    GREEN = "rgb(0,255,0)",
                    BLUE = "rgb(0,0,255)";

                function createTooltip(options) {
                    tooltip = new dataviz.Tooltip($("#chart"), options);
                    element = tooltip.element;
                    element.css({ width: "45px", height: "35px" });
                }

                function showNow(point) {
                    tooltip.point = point;
                    tooltip._show();
                }

                function createPoint(options) {
                    dataPointMock = {
                        value: 1,
                        box: new dataviz.Box2D(0, 0, 10, 10),
                        options: {
                            aboveAxis: true,
                            color: RED
                        },
                        series: {
                            name: "series",
                            labels: {
                                color: GREEN
                            }
                        },
                        category: "category",
                        dataItem: {
                            field: "value"
                        },
                        tooltipAnchor: function() {
                            return new dataviz.Point2D();
                        },
                        owner: {
                            formatPointValue: function(value, tooltipFormat) {
                                return kendo.dataviz.autoFormat(tooltipFormat, value);
                            }
                        },
                        formatValue: function(format) {
                            var point = this;

                            return point.owner.formatPointValue(point.value, format);
                        }
                    };

                    $.extend(dataPointMock, options);
                }

                // ------------------------------------------------------------
                module("Tooltip", {
                    setup: function() {
                        createTooltip();
                        createPoint();
                    },
                    teardown: function() {
                        element.remove();
                    }
                });

                test("attaches to chart element", function() {
                    ok(element[0].parentNode === document.getElementById("chart"));
                });

                test("renders div with display none attribute", function() {
                    ok(element.css("display"), "none");
                });

                test("sets font", function() {
                    createTooltip({ font: "16px Tahoma" });
                    equals(element.css("fontSize"), "16px");
                    equals(element.css("fontFamily"), "Tahoma");
                });

                test("sets series tooltip font", function() {
                    createTooltip();
                    showNow(kendo.deepExtend({}, dataPointMock, {
                        options: {
                            tooltip: {
                                font: "16px Tahoma"
                            }
                        }
                    }));
                    equals(element.css("fontSize"), "16px");
                    equals(element.css("fontFamily"), "Tahoma");
                });

                test("sets border width", function() {
                    createTooltip({ border: { width: 1 } });
                    equals(element.css("border-top-width"), "1px");
                });

                test("sets opacity", function() {
                    createTooltip({ opacity: 0.5 });
                    equals(element.css("opacity"), 0.5);
                });

                asyncTest("show displays tooltip for last point with a delay", function() {
                    tooltip.show({ /* Fake */ });
                    tooltip.show(dataPointMock);

                    setTimeout(function() {
                        equals(element.text(), "1");
                        start();
                    }, 120);
                });

                test("can override border color", function() {
                    createTooltip({ border: { color: RED } });
                    showNow(dataPointMock);
                    equals(element.css("border-top-color").replace(/\s/g, ''), RED);
                });

                test("sets border color to current point color", function() {
                    showNow(dataPointMock);
                    equals(element.css("border-top-color").replace(/\s/g, ''), RED);
                });

                test("sets div background", function() {
                    tooltip.options.background = BLUE;
                    showNow(dataPointMock);
                    equals(element.css("backgroundColor").replace(/\s/g, ''), BLUE);
                });

                test("sets text color", function() {
                    createTooltip({ color: GREEN });
                    showNow(dataPointMock);
                    equals(element.css("color").replace(/\s/g, ''), GREEN);
                });

                test("applies full label format", function() {
                    createTooltip({ format: "{0}%" });
                    showNow(dataPointMock);
                    equals(element.text(), "1%");
                });

                test("applies simple label format", function() {
                    createTooltip({ format: "p0" });
                    showNow(dataPointMock);
                    equals(element.text(), "100 %");
                });

                test("renders template", function() {
                    createTooltip({ template: "${value}%" });
                    showNow(dataPointMock);
                    equals(element.text(), "1%");
                });

                test("renders compiled template", function() {
                    createTooltip({ template: kendo.template("${value}%") });
                    showNow(dataPointMock);
                    equals(element.text(), "1%");
                });

                test("renders template when format is set", function() {
                    createTooltip({ format: "{0} percent", template: "${value}%" });
                    showNow(dataPointMock);
                    equals(element.text(), "1%");
                });

                test("template context has category", function() {
                    createTooltip({ template: "${category}" });
                    showNow(dataPointMock);
                    equals(element.text(), "category");
                });

                test("template context has series", function() {
                    createTooltip({ template: "${series.name}" });
                    showNow(dataPointMock);
                    equals(element.text(), "series");
                });

                test("template context has dataItem", function() {
                    createTooltip({ template: "${dataItem.field}" });
                    showNow(dataPointMock);
                    equals(element.text(), "value");
                });

                test("positions tooltip on anchor", function() {
                    dataPointMock.tooltipAnchor = function() { return new dataviz.Point2D(10, 20) };
                    tooltip.options.animation.duration = 0;
                    tooltip.options.offsetX = 0;
                    tooltip.options.offsetY = 0;
                    showNow(dataPointMock);

                    same([parseInt(tooltip.element.css("left"), 10),
                          parseInt(tooltip.element.css("top"), 10)],
                          [10, 20]);
                });

                test("positions accounts for chart padding", function() {
                    $("#chart").css({
                        "padding-left": "10px",
                        "padding-top": "20px"
                    });

                    createTooltip();
                    createPoint();

                    dataPointMock.tooltipAnchor = function() { return new dataviz.Point2D(10, 20) };
                    tooltip.options.animation.duration = 0;
                    showNow(dataPointMock);

                    same([parseInt(tooltip.element.css("left"), 10),
                          parseInt(tooltip.element.css("top"), 10)],
                          [20, 40]);

                    $("#chart").css({
                        "padding-left": "0px",
                        "padding-top": "0px"
                    });
                });

                test("applies format from the series", function() {
                    createPoint({ options: { tooltip: { format: "{0:C}" } }});
                    showNow(dataPointMock);
                    equals(element.text(), "$1.00");
                });

            })();


            (function() {
                var tooltip,
                    element,
                    dataPointMock,
                    RED = "rgb(255,0,0)";

                function createTooltip() {
                    tooltip = new dataviz.Tooltip($("#chart"), {
                        background: "black",
                        border: {
                            width: 5,
                            color: "red"
                        },
                        visible: false
                    });

                    element = tooltip.element;
                    element.css({ width: "45px", height: "35px" });
                }

                function showNow(point) {
                    tooltip.point = point;
                    tooltip._show();
                }

                function createSeriesPoint(options) {
                    dataPointMock = {
                        value: 1,
                        box: new dataviz.Box2D(0, 0, 10, 10),
                        options: {
                            aboveAxis: true,
                            color: RED,
                            tooltip: {
                                border: {
                                    color: "blue",
                                    width: 2
                                },
                                visible: true,
                                color: "red",
                                background: "green",
                                opacity: 1
                            }
                        },
                        category: "category",
                        dataItem: {
                            field: "value"
                        },
                        tooltipAnchor: function() {
                            return new dataviz.Point2D();
                        },
                        owner: {
                            formatPointValue: function(value, tooltipFormat) {
                                return kendo.format(tooltipFormat, value);
                            }
                        },
                        formatPointValue: function(format) {
                            var point = this;

                            return point.owner.formatPointValue(point.value, format);
                        }
                    };

                    $.extend(dataPointMock, options);
                }

                // ------------------------------------------------------------
                module("Tooltip / Series", {
                    setup: function() {
                        createTooltip();
                        createSeriesPoint();
                    },
                    teardown: function() {
                        element.remove();
                    }
                });

                test("sets border width", function() {
                    showNow(dataPointMock);
                    equals(element.css("border-top-width"), "2px");
                });

                test("sets opacity", function() {
                    showNow(dataPointMock);
                    equals(element.css("opacity"), 1);
                });

            })();

        </script>

        <div id="chart"></div>

        <h1 id="qunit-header">kendo.chart</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

    </body>
</html>

