<html>
    <head>
        <title>treeview MVVM support</title>
        <script src="../../src/jquery.js"></script>
        <script type="text/javascript" src="../qunit/qunit/qunit.js"></script>
        <script type="text/javascript" src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.binder.js"></script>
        <script src="../../src/kendo.fx.js"></script>
        <script src="../../src/kendo.userevents.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.treeview.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" ></div>
    </head>
    <body>
        <h1 id="qunit-header"></h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            module("MVVM", {
                teardown: function() {
                    $(".k-treeview").remove();
                }
            });
            test("initializes a treeview when data role is treeview", function() {
                var dom = $('<ul data-role="treeview"></ul>');

                kendo.bind(dom);

                ok(dom.data("kendoTreeView") instanceof kendo.ui.TreeView);
            });

            test("initializes a options from data attributes", function() {
                var dom = $('<ul data-role="treeview" data-animation="false"></ul>');

                kendo.bind(dom);

                var treeview = dom.data("kendoTreeView");

                ok($.isEmptyObject(treeview.options.animation.effects));
            });

            test("binding treeview initialized before binding", function() {
                var dom = $('<ul data-animation="false"></ul>');

                var treeview = dom.kendoTreeView().data("kendoTreeView");

                kendo.bind(dom);

                ok($.isEmptyObject(treeview.options.animation.effects));
            });

            test("binding containing binding attributes", function() {
                var dom = $('<ul data-role="treeview"><span data-bind="text:text"></span></ul>');

                var observable = kendo.observable({ text:"foo" });

                kendo.bind(dom, observable);

                equal($.trim(dom.find("span:first").html()), "foo");
            });

            test("updating viewModel updates the content", function() {
                var dom = $('<ul data-role="treeview"><span data-bind="text:text"></span></ul>');

                var observable = kendo.observable({ text:"foo" });

                kendo.bind(dom, observable);

                observable.set("text", "bar");

                equal($.trim(dom.find("span:first").html()), "bar");
            });

            test("event is raised if attached as option", 1, function() {
                var dom = $('<ul data-role="treeview" data-select="select"></ul>');

                kendo.bind(dom);

                dom.data("kendoTreeView").trigger("select");
            });

            function select() {
                ok(true);
            }

            test("binding visible to true shows the treeview", function() {
                var dom = $('<div data-role="treeview" data-bind="visible: visible"></div>');

                kendo.bind(dom, { visible: true });

                var treeview = dom.data("kendoTreeView");

                ok(treeview.wrapper.css("display") != "none", "treeview is visible");
            });

            test("binding visible to false hides the treeview", function() {
                var dom = $('<div data-role="treeview" data-bind="visible: visible"></div>');

                kendo.bind(dom, { visible: false });

                var treeview = dom.data("kendoTreeView");

                ok(treeview.wrapper.css("display") == "none", "treeview is not visible");
            });

            test("binding invisible to true hides the treeview", function() {
                var dom = $('<div data-role="treeview" data-bind="invisible: invisible"></div>');

                kendo.bind(dom, { invisible: true });

                var treeview = dom.data("kendoTreeView");

                ok(treeview.wrapper.css("display") == "none", "treeview is invisible");
            });

            test("binding invisible to false shows the treeview", function() {
                var dom = $('<div data-role="treeview" data-bind="invisible: invisible"></div>');

                kendo.bind(dom, { invisible: false });

                var treeview = dom.data("kendoTreeView");

                ok(treeview.wrapper.css("display") != "none", "treeview is not invisible");
            });

            test("source binding", function() {
                var dom = $('<div data-role="treeview" data-bind="source: source"></div>');

                var viewModel = kendo.observable({
                    source: new kendo.data.HierarchicalDataSource({
                        data: [
                            { text: "baz" }
                        ]}
                    )
                });

                kendo.bind(dom, viewModel);

                equal(dom.text(), "baz");
            });

            test("template binding", function() {
                var dom = $(
                    '<div data-role="treeview" data-template="fooTemplate" data-bind="source: source"></div>'
                );

                var viewModel = kendo.observable({
                    source: [
                        { text: "bar" }
                    ]
                });

                kendo.bind(dom, viewModel);

                equal(dom.text(), "bar foo");
            });


            (function() {
                var viewModel, dom;

                function setupObservableBinding(data) {
                    viewModel = kendo.observable({
                            products: kendo.observableHierarchy(data)
                        });

                    dom = $('<div />').appendTo("body")
                        .kendoTreeView({
                            dataSource: viewModel.products
                        });
                }

                test("binding to hierarchical observable", function() {
                    setupObservableBinding([
                        { text: "foo", expanded: true, items: [
                            { text: "bar" }
                        ] }
                    ]);

                    viewModel.get("products")[0].get("items")[0].set("text", "baz");

                    equal(dom.find(".k-item .k-item").text(), "baz");
                });

                test("adding children to child array adds them to the treeview", function() {
                    setupObservableBinding([
                        { text: "foo", items: [] }
                    ]);

                    viewModel.products[0].items.push({ text: "bar" });

                    equal(dom.find(".k-item .k-item").length, 1);
                    equal(dom.find(".k-item .k-item").text(), "bar");
                });

                test("removing children to child array removes them from the treeview", function() {
                    setupObservableBinding([
                        { text: "foo", items: [
                            { text: "bar" }
                        ] }
                    ]);

                    viewModel.products[0].items.splice(0, 1);

                    equal(dom.find(".k-item .k-item").length, 0);
                });

                test("setting selected field selects node", function() {
                    setupObservableBinding([
                        { text: "foo" }
                    ]);

                    viewModel.products[0].set("selected", true);

                    equal(dom.find(".k-state-selected").length, 1);
                });

                test("selecting a node sets the node selected flag", function() {
                    setupObservableBinding([
                        { text: "foo" }
                    ]);

                    dom.find(".k-in").trigger("click");

                    ok(viewModel.products[0].get("selected"));
                });

                test("selecting a node removes selected flag from other nodes", function() {
                    setupObservableBinding([
                        { text: "foo", selected: true },
                        { text: "bar" }
                    ]);

                    dom.find(".k-in:last").trigger("click");

                    ok(!viewModel.products[0].get("selected"));
                });

            })();

        </script>

        <script id="fooTemplate" type="text/x-kendo-template">#:item.text# foo</script>

        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
