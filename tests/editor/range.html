<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>kendo.ui.Editor Tests</title>

<script src="../../src/jquery.js"></script>
<script src="../qunit/qunit/qunit.js"></script>
<script src="../qunit-runner.js"></script>
<script src="../../src/kendo.core.js"></script>
<script src="../../src/kendo.fx.js"></script>
<script src="../../src/kendo.data.js"></script>
<script src="../../src/kendo.popup.js"></script>
<script src="../../src/kendo.list.js"></script>
<script src="../../src/kendo.combobox.js"></script>
<script src="../../src/kendo.dropdownlist.js"></script>
<script src="../../src/kendo.window.js"></script>
<script src="../../src/kendo.colorpicker.js"></script>
        <script src="../../src/kendo.editor.js"></script>
<script src="util.js"></script>

<link rel="stylesheet" href="../qunit/qunit/qunit.css" />
<link rel="stylesheet" href="../../styles/web/kendo.common.css" />

<style> html { font-size: 12px; } </style>
</head>
<body>

<div><textarea cols="20" rows="4" id="Editor1" name="Editor1"></textarea></div>

<script>

$("#Editor1").kendoEditor();

function getRange() {
    return getEditor().createRange(document);
}

/* traversal tests */

function getRangeFromHtml(html) {
    var editor = getEditor();

    editor.value(html);

    var range = editor.createRange();
    range.setStartBefore(editor.body.firstChild);
    range.setEndAfter(editor.body.lastChild);

    return range;
}

module("Editor / Range", {
    setup: function() {
        editor = getEditor();
    }
});

test('range creation', function() {
    var range = editor.createRange();

    equal(range.startContainer, editor.document);
    equal(range.endContainer, editor.document);
    equal(range.commonAncestorContainer, editor.document);
    equal(range.startOffset, 0);
    equal(range.endOffset, 0);
    equal(range.collapsed, true);
});

test('setStart setEnd within the same text node', function() {
    editor.value('this is only a test of the <span>emergency</span> <em>broadcast</em> system');

    var range = editor.createRange();

    range.setStart(editor.body.firstChild, 2);
    range.setEnd(editor.body.firstChild, 10);

    equal(range.startContainer, editor.body.firstChild);
    equal(range.endContainer, editor.body.firstChild);
    equal(range.commonAncestorContainer, editor.body.firstChild);
    equal(range.startOffset, 2);
    equal(range.endOffset, 10);
    equal(range.collapsed, false);
});

test('setStart setEnd collapsing', function() {
    editor.value('this is only a test of the <span>emergency</span> <em>broadcast</em> system');

    var range = editor.createRange();

    range.setStart(editor.body.firstChild, 4);
    range.setEnd(editor.body.firstChild, 4);

    equal(range.collapsed, true);
});

test('setStart setEnd in different containers', function() {
    editor.value('this is only a test of the <span>emergency</span> <em>broadcast</em> system');

    var range = editor.createRange();

    range.setStart(editor.body.childNodes[1].firstChild, 2);
    range.setEnd(editor.body.childNodes[3].firstChild, 3);

    equal(range.commonAncestorContainer, editor.body);
});

test('setStart setEnd in nested containers', function() {
    editor.value('this is only a test of the <span>emergency</span> <em>broadcast</em> system');

    var range = editor.createRange();

    range.setStart(editor.body.firstChild, 2);
    range.setEnd(editor.body.childNodes[1].firstChild, 3);

    equal(range.commonAncestorContainer, editor.body);
});

test('selectNode selects node', function() {
    editor.value('<strong>golga</strong>');

    var range = editor.createRange();

    range.selectNode(editor.body.firstChild);

    equal(range.commonAncestorContainer, editor.body);

    equal(range.startContainer, editor.body);
    equal(range.endContainer, editor.body);
    equal(range.startOffset, 0);
    equal(range.endOffset, 1);
});

test('selectNodeContents selects node contents', function() {
    editor.value('<strong>golga</strong>');

    var range = editor.createRange();

    range.selectNodeContents(editor.body.firstChild);

    equal(range.commonAncestorContainer, editor.body.firstChild);

    equal(range.startContainer, editor.body.firstChild);
    equal(range.endContainer, editor.body.firstChild);
    equal(range.startOffset, 0);
    equal(range.endOffset, 1);
});

test('selectNodeContents on img', function() {
    editor.value('<img src="foo" />');

    var range = editor.createRange();

    range.selectNodeContents(editor.body.firstChild);

    equal(range.commonAncestorContainer, editor.body.firstChild);
    equal(range.startContainer, editor.body.firstChild);
    equal(range.endContainer, editor.body.firstChild);
    equal(range.startOffset, 0);
    equal(range.endOffset, 0);

    range.collapse(true);

    equal(range.commonAncestorContainer, editor.body.firstChild);
    equal(range.startContainer, editor.body.firstChild);
    equal(range.endContainer, editor.body.firstChild);
    equal(range.startOffset, 0);
    equal(range.endOffset, 0);
});

test('insertNode on expanded range in text element', function() {
    editor.value('golgafrincham');

    var range = editor.createRange();
    range.setStart(editor.body.firstChild, 5);
    range.setEnd(editor.body.firstChild, 10);

    range.insertNode(editor.document.createElement('span'));

    equal(editor.value(), 'golga<span></span>frincham');
});

test('insertNode on expanded range inserts node at start', function() {
    editor.value('<p>foo</p>');

    var range = editor.createRange();
    range.selectNode(editor.body.firstChild);

    range.insertNode(editor.document.createElement('span'));

    equal(editor.value(), '<span></span><p>foo</p>');
});

test('insertNode on collapsed range at end of text element', function() {

    editor.value('golgafrincham<br />');

    var range = editor.createRange();
    range.setStart(editor.body.firstChild, 13);
    range.setEnd(editor.body.firstChild, 13);

    range.insertNode(editor.document.createElement('span'));

    equal(editor.value(), 'golgafrincham<span></span><br />');
});

test('extractContents on text node', function() {
    editor.value('golgafrincham');

    var range = editor.createRange();

    range.setStart(editor.body.firstChild, 5);
    range.setEnd(editor.body.firstChild, 9);

    var contents = range.extractContents();

    equal(contents.firstChild.nodeValue, 'frin');
    equal(editor.value(), 'golgacham');
});

test('extractContents extracts tags', function() {
    editor.value('golga<strong>frincham</strong>');

    var range = editor.createRange();

    range.setStart(editor.body.lastChild.firstChild, 4);
    range.setEndAfter(editor.body.lastChild);

    var contents = range.extractContents();

    equal(contents.childNodes.length, 1);
    equal(contents.firstChild.tagName.toLowerCase(), 'strong');
    equal(contents.firstChild.innerHTML.toLowerCase(), 'cham');
    equal(editor.value(), 'golga<strong>frin</strong>');
});

test('extractContents after range manipulation', function() {
    editor.value('golga<strong>frincham</strong>');

    var range = editor.createRange();

    range.setStart(editor.body.firstChild, 0);
    range.setEnd(editor.body.firstChild, 4);

    range = range.cloneRange();
    range.collapse(false);
    range.setEndAfter(editor.body.lastChild);

    var contents = range.extractContents();

    equal(editor.value(), 'golg');
    equal(contents.childNodes.length, 2);
    equal(contents.firstChild.nodeValue, 'a');
    equal(contents.lastChild.tagName.toLowerCase(), 'strong');
    equal(contents.lastChild.firstChild.nodeValue, 'frincham');
});

test('extractContents updates original range when container is text node', function() {
    var range = createRangeFromText(editor, "<strong>f|oo|</strong>");

    var leftRange = range.cloneRange();
    leftRange.collapse(true);
    leftRange.setStartBefore(editor.body.lastChild);
    leftRange.extractContents();

    equal(range.startContainer, editor.body.lastChild.firstChild);
    equal(range.endContainer, editor.body.lastChild.firstChild);
    equal(range.startOffset, 0);
    equal(range.endOffset, 2);
});

test('extractContents updates original range when container is element node', function() {
    var range = createRangeFromText(editor, '<strong>|fo|o</strong>');

    var marker = new kendo.ui.editor.Marker();
    marker.add(range);

    var leftRange = range.cloneRange();
    leftRange.collapse(true);
    leftRange.setStartBefore(editor.body.firstChild);
    leftRange.extractContents();

    equal(range.startContainer, editor.body.firstChild);
    equal(range.endContainer, editor.body.firstChild);
    equal(range.startOffset, 0);
    equal(range.endOffset, 3);
});

test('extractContents updates original range when whole text element is removed', function() {
    editor.value('<p>foo</p><p>bar<a></a>baz</p>')
    var range = editor.createRange();
    var anchor = editor.body.lastChild.childNodes[1];
    range.selectNode(anchor);

    var leftRange = range.cloneRange();
    leftRange.collapse(true);
    leftRange.setStartBefore(anchor.parentNode);

    leftRange.extractContents();

    equal(range.startContainer, editor.body.lastChild);
    equal(range.endContainer, editor.body.lastChild);
    equal(range.startOffset, 0);
    equal(range.endOffset, 1);
});

test('extractContents does not update original range when outside range', function() {
    editor.value('<p>foo</p><p>bar<strong>baz</strong>foo</p>')
    var range = editor.createRange();
    var anchor = editor.body.lastChild.childNodes[1];
    range.selectNode(anchor);

    var rightRange = range.cloneRange();
    rightRange.collapse(false);
    rightRange.setEndAfter(anchor.parentNode);
    rightRange.extractContents();

    equal(range.startContainer, editor.body.lastChild);
    equal(range.endContainer, editor.body.lastChild);
    equal(range.startOffset, 1);
    equal(range.endOffset, 2);
});

test('setStart to marker after end collapses range to new start', function() {
    var range = createRangeFromText(editor, '|f|oo');

    range.setStart(editor.body.firstChild, 2);

    equal(range.startContainer, editor.body.firstChild);
    equal(range.endContainer, editor.body.firstChild);
    equal(range.commonAncestorContainer, editor.body.firstChild);
    equal(range.startOffset, 2);
    equal(range.endOffset, 2);
    equal(range.collapsed, true);
});

test('setEnd to marker before start collapses range to new end', function() {
    var range = createRangeFromText(editor, 'fo|o|');

    range.setEnd(editor.body.firstChild, 1);

    equal(range.startContainer, editor.body.firstChild);
    equal(range.endContainer, editor.body.firstChild);
    equal(range.commonAncestorContainer, editor.body.firstChild);
    equal(range.startOffset, 1);
    equal(range.endOffset, 1);
    equal(range.collapsed, true);
});

test('setStart validation across nested containers', function() {
    var range = createRangeFromText(editor, '<div><span>f|oo</span><span>ba|r</span></div>');

    range.setStart(editor.body.firstChild, 2);

    equal(range.startContainer, editor.body.firstChild);
    equal(range.endContainer, editor.body.firstChild);
    equal(range.commonAncestorContainer, editor.body.firstChild);
    equal(range.startOffset, 2);
    equal(range.endOffset, 2);
    equal(range.collapsed, true);
});

test('setStart validation across sibling containers', function() {
    var range = createRangeFromText(editor, '<span>f|oo</span><span>ba|r</span><span>baz</span');

    range.setStart(editor.body.lastChild.firstChild, 2);

    equal(range.startContainer, editor.body.lastChild.firstChild);
    equal(range.endContainer, editor.body.lastChild.firstChild);
    equal(range.commonAncestorContainer, editor.body.lastChild.firstChild);
    equal(range.startOffset, 2);
    equal(range.endOffset, 2);
    equal(range.collapsed, true);
});

test('setEnd validation across nested containers', function() {
    var range = createRangeFromText(editor, '<div><span>f|oo</span><span>ba|r</span></div>');

    range.setEnd(editor.body.firstChild, 0);

    equal(range.startContainer, editor.body.firstChild);
    equal(range.endContainer, editor.body.firstChild);
    equal(range.commonAncestorContainer, editor.body.firstChild);
    equal(range.startOffset, 0);
    equal(range.endOffset, 0);
    equal(range.collapsed, true);
});

test('setEnd validation across sibling containers', function() {
    var range = createRangeFromText(editor, '<span>foo</span><span>ba|r</span><span>ba|z</span');

    range.setEnd(editor.body.firstChild.firstChild, 2);

    equal(range.startContainer, editor.body.firstChild.firstChild);
    equal(range.endContainer, editor.body.firstChild.firstChild);
    equal(range.commonAncestorContainer, editor.body.firstChild.firstChild);
    equal(range.startOffset, 2);
    equal(range.endOffset, 2);
    equal(range.collapsed, true);
});

test('setEndAfter validation across sibling containers', function() {
    editor.value('<p>foo<strong>bar</strong>baz<br />foo<em>bar</em>baz<br />foo</p>');

    var range = editor.createRange();

    range.setStart(editor.body.firstChild.childNodes[1], 1);
    range.setEnd(editor.body.firstChild.childNodes[5], 1);

    range.collapse(false);
    range.setEndAfter(editor.body.firstChild.childNodes[1]);

    equal(range.startContainer, editor.body.firstChild);
    equal(range.endContainer, editor.body.firstChild);
    equal(range.commonAncestorContainer, editor.body.firstChild);
    equal(range.startOffset, 2);
    equal(range.endOffset, 2);
    equal(range.collapsed, true);
});

test('getRange returns body when editor is empty', function() {
    editor.value('');
    editor.focus();

    var range = editor.getRange();

    equal(range.startContainer, editor.body);
    equal(range.endContainer, editor.body);
    equal(range.startOffset, 0);
    equal(range.endOffset, 0);
});

</script>

<h1 id="qunit-header">kendo.ui.Editor Tests</h1>
<h2 id="qunit-banner"></h2>
<div id="qunit-testrunner-toolbar"></div>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<div id="qunit-fixture">test markup, will be hidden</div>
<ul id="log"></ul>

</body>
</html>
