<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>kendo.ui.Editor Tests</title>

        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.fx.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.popup.js"></script>
        <script src="../../src/kendo.list.js"></script>
        <script src="../../src/kendo.combobox.js"></script>
        <script src="../../src/kendo.dropdownlist.js"></script>
        <script src="../../src/kendo.window.js"></script>
        <script src="../../src/kendo.editor.js"></script>
        <script src="util.js"></script>

        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
        <link rel="stylesheet" href="../../styles/web/kendo.common.css" />

        <style> html { font-size: 12px; } </style>
    </head>
    <body>

        <div><textarea cols="20" rows="4" id="Editor1" name="Editor1"></textarea></div>

        <script>

            $("#Editor1").kendoEditor({
                messages: {
                    unlink: "unlink foo"
                }
            });

            var componentType = kendo.support.browser.msie ? 'kendoDropDownList' : 'kendoComboBox';

            function value($ui) {
                return kendo.support.browser.msie ? $.trim($ui.text()) : $ui.val();
            }

            module("Editor / Toolbar", {
                setup: function() {
                    window.editor = getEditor();
                }
            });

            test('initially fontName should have "inherit" value', function () {
                editor.value("foo");

                var component = $('select.k-fontSize').data(componentType);

                equal(component.value(), 'inherit');
            });

            test('exec with node parameter calls exec', function() {
                var editor = getEditor();

                var execArgs = [];

                editor.exec = function() { execArgs = arguments; };

                $('.k-bold', editor.wrapper).click();

                equal(execArgs.length, 1);
                equal(execArgs[0], 'bold');
            });

            test('handle carret selection', function() {
                editor.value('<strong>foo</strong>')
                var range = editor.createRange();
                range.setStart(editor.body.firstChild.firstChild, 1);
                range.setEnd(editor.body.firstChild.firstChild, 1);

                editor.getSelection().removeAllRanges();
                editor.getSelection().addRange(range);

                editor.trigger('select');

                ok($('.k-bold', editor.wrapper).hasClass('k-state-active'));
            });

            test('handle word selection', function() {
                editor.value('<strong>foo</strong>')
                var range = editor.createRange();
                range.selectNodeContents(editor.body.firstChild);

                editor.getSelection().removeAllRanges();
                editor.getSelection().addRange(range);

                editor.trigger('select');

                ok($('.k-bold', editor.wrapper).hasClass('k-state-active'));
            });

            test('handle mixed selection', function() {
                editor.value('<ul><li>foo</li></ul><ul><li>bar</li></ul>')
                var range = editor.createRange();
                range.setStart(editor.body.firstChild.firstChild.firstChild, 1);
                range.setEnd(editor.body.firstChild.firstChild.firstChild, 1);

                editor.getSelection().removeAllRanges();
                editor.getSelection().addRange(range);

                editor.trigger('select');

                ok(!$('k-insertUnorderedList', editor.wrapper).hasClass('k-state-active'));
            });

            test('handle image selection', function() {
                editor.value('<img style="float:right" src="foo" />');
                var range = editor.createRange();
                range.selectNode(editor.body.firstChild);

                editor.getSelection().removeAllRanges();
                editor.getSelection().addRange(range);

                editor.trigger('select');

                ok($('.k-justifyRight', editor.wrapper).hasClass('k-state-active'));
            });

            test('font size combobox on mixed content', function() {
                editor.selectRange(createRangeFromText(editor, '|foo<span style="font-size:8px;">bar|</span>'));

                editor.trigger('select');

                equal(value($('.k-fontSize', editor.wrapper)), '');
            });

            test('font size combobox on custom font size', function() {
                editor.selectRange(createRangeFromText(editor, '<span style="font-size:8px;">f|o|o</span>'));

                editor.trigger('select');

                equal(value($('.k-fontSize', editor.wrapper)), '8px');
            });

            test('inherited font size', function() {
                editor.selectRange(createRangeFromText(editor, '<span>f|o|o</span>'));

                editor.trigger('select');

                equal(value($('.k-fontSize', editor.wrapper)), editor.options.messages.fontSizeInherit);
            });

            test('font size combobox on relative font size', function() {
                editor.selectRange(createRangeFromText(editor, '<span style="font-size:x-small;">f|o|o</span>'));

                editor.trigger('select');

                equal(value($('.k-fontSize', editor.wrapper)), '2 (10pt)');
            });

            test('clicking disabled links should not navigate', function() {
                var isDefaultPrevented = false,
                navigationListener = function(e) {
                    isDefaultPrevented = e.isDefaultPrevented();
                };

                editor.wrapper.bind('click', navigationListener);

                $('.k-editor-button .k-tool-icon.k-state-disabled').trigger('click');

                editor.wrapper.unbind('click', navigationListener);

                ok(isDefaultPrevented);
            });

            test('buttons honor to-be-applied pending formats', function() {
                editor.value('foo')
                var range = editor.createRange();
                range.setStart(editor.body.firstChild, 1);
                range.collapse(true);

                editor.selectRange(range);

                editor.pendingFormats.toggle({ name: 'bold', params: undefined, command: editor.options.tools.bold.command });

                editor.trigger('select');

                ok($('.k-bold', editor.wrapper).hasClass('k-state-active'));
            });

            test('buttons honor to-be-removed pending formats', function() {
                editor.value('<strong>foo</strong>')
                var range = editor.createRange();
                range.setStart(editor.body.firstChild.firstChild, 1);
                range.collapse(true);

                editor.selectRange(range);

                editor.pendingFormats.toggle({ name: 'bold', params: undefined, command: editor.options.tools.bold.command });

                editor.trigger('select');

                ok(!$('.k-bold', editor.element).hasClass('k-state-active'));
            });

            test('combos honor to-be-applied pending formats', function() {
                editor.value('foo')
                var range = editor.createRange();
                range.setStart(editor.body.firstChild, 1);
                range.collapse(true);

                editor.selectRange(range);

                editor.pendingFormats.toggle({ name: 'fontsize', options: { params: { value: 'xx-large' } }, command: editor.options.tools.fontSize.command });

                editor.trigger('select');

                equals($('select.k-fontSize').data(componentType).value(), 'xx-large');
            });

            test("unlink applies custom title", function() {
                equal(editor.wrapper.find(".k-unlink").attr("title"), "unlink foo");
            });

        </script>

        <h1 id="qunit-header">kendo.ui.Editor Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

    </body>
</html>
