<!DOCTYPE html>
<html>
    <head>
        <title>Query Tests</title>
        <script src="../jquery-loader.js"></script>
        <script type="text/javascript" src="../qunit/qunit/qunit.js"></script>
        <script src="../kendo-test-helpers.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.model.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">QUnit example</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var DataReader = kendo.data.DataReader;

            test("data returns the passed value by default", function() {
                var reader = new DataReader(), result = {};

                ok(reader.data(result) === result);
            });

            test("groups returns the passed value by default", function() {
                var reader = new DataReader(), result = {};

                ok(reader.groups(result) === result);
            });

            test("members of the schema override the prototype members", function() {
                var reader = new DataReader({
                    data: function(result) {
                        return result + "bar"
                    }
                });

                equal(reader.data("foo"), "foobar");
            });

            test("string members of the schema are treated as getters", function() {
                var reader = new DataReader({
                    data: "foo"
                });

                equal(reader.data({ foo: "bar" }), "bar");
            });

            test("total returns the length by default", function() {
                var reader = new DataReader();

                equal(reader.total([1]), 1);
            });

            test("status returns the status field by default", function() {
                var reader = new DataReader();

                equal(reader.status({ status: "foo" }), "foo");
            });

            test("aggregates returns an empty object default", function() {
                var reader = new DataReader();

                ok($.isEmptyObject(reader.aggregates()));
            });

            test("model is initialized if passed", function() {
                var reader = new DataReader({
                    model: {}
                });

                ok(new reader.model instanceof kendo.data.Model);
            });

            test("converts field values to the specifed type", function() {
                var reader = new DataReader({
                    model: {
                        fields: {
                            bar: { type: "number" },
                            baz: "baz"
                        }
                    }
                });

                var result = reader.parse([{ bar: "1", baz: "baz1"}, { bar: "", baz: "baz2"}, { bar: "0", baz: "baz3"}]);
                result = reader.data(result);

                equal(result.length, 3);
                strictEqual(result[0].bar, 1);
                strictEqual(result[0].baz, "baz1");
                strictEqual(result[1].bar, null);
                strictEqual(result[1].baz, "baz2");
                strictEqual(result[2].bar, 0);
                strictEqual(result[2].baz, "baz3");
            });

            test("converts field values to the specifed type with server groups", function() {
                var reader = new DataReader({
                    model: {
                        fields: {
                            bar: { type: "number" },
                            baz: "baz"
                        }
                    }
                });

                var result = reader.parse([ { items: [{ bar: "1", baz: "baz1"}, { bar: "", baz: "baz2"}, { bar: "0", baz: "baz3"}], field: "bar", value: "0" }]);
                result = reader.groups(result)[0];

                var items = result.items;

                equal(items.length, 3);
                strictEqual(items[0].bar, 1);
                strictEqual(items[0].baz, "baz1");
                strictEqual(items[1].bar, null);
                strictEqual(items[1].baz, "baz2");
                strictEqual(items[2].bar, 0);
                strictEqual(items[2].baz, "baz3");

                strictEqual(result.value, 0);
            });

            test("converts field values to the specifed type with external model definition", function() {
                var Model = kendo.data.Model.define({
                    fields: {
                        bar: { type: "number" },
                        baz: "baz"
                    }
                });

                var reader = new DataReader({
                    model: Model
                });

                var result = reader.parse([{ bar: "1", baz: "baz1"}, { bar: "", baz: "baz2"}, { bar: "0", baz: "baz3"}]);
                result = reader.data(result);

                equal(result.length, 3);
                strictEqual(result[0].bar, 1);
                strictEqual(result[0].baz, "baz1");
                strictEqual(result[1].bar, null);
                strictEqual(result[1].baz, "baz2");
                strictEqual(result[2].bar, 0);
                strictEqual(result[2].baz, "baz3");
            });

            test("converts field values to the specifed type with multiple nested server groups", function() {
                var reader = new DataReader({
                    model: {
                        fields: {
                            bar: { type: "number" },
                            baz: "baz"
                        }
                    }
                });

                var result = reader.parse([ {
                    hasSubgroups: true, items: [
                            { items: [{ bar: "1", baz: "baz1"}, { bar: "", baz: "baz2"}, { bar: "0", baz: "baz3"}], field:"bar", value: "0" }
                        ],
                        field: "bar",
                        value: "0"
                    }]);

                result = reader.groups(result)[0];

                strictEqual(result.items[0].value, 0);

                var items = result.items[0].items;

                equal(items.length, 3);
                strictEqual(items[0].bar, 1);
                strictEqual(items[0].baz, "baz1");
                strictEqual(items[1].bar, null);
                strictEqual(items[1].baz, "baz2");
                strictEqual(items[2].bar, 0);
                strictEqual(items[2].baz, "baz3");

            });

            test("fields not in the model are persisted", function() {
                var reader = new DataReader({
                    model: {
                        fields: {
                            bar: { type: "number" }
                        }
                    }
                });

                var result = reader.parse([{ bar: "1", baz: "baz1"}, { bar: "", baz: "baz2"}, { bar: "0", baz: "baz3"}]);
                result = reader.data(result);

                equal(result.length, 3);
                strictEqual(result[0].bar, 1);
                strictEqual(result[0].baz, "baz1");
                strictEqual(result[1].bar, null);
                strictEqual(result[1].baz, "baz2");
                strictEqual(result[2].bar, 0);
                strictEqual(result[2].baz, "baz3");
            });

            test("custom data function is called when model is defined", function() {
                var called = false,
                    reader = new DataReader({
                        model: {
                            fields: {
                                bar: { type: "number" },
                                baz: "baz"
                            }
                        },
                        data: function() {
                            called = true;
                            return [];
                        }
                    });

                var result = reader.parse([{ bar: "1", baz: "baz1"}, { bar: "", baz: "baz2"}, { bar: "0", baz: "baz3"}]);
                result = reader.data(result);
                ok(called);
            });

            test("data retuns empty observable array when such is passed and a model is declared", function() {
                var reader = new DataReader({
                    model: {
                        fields: {
                            bar: { type: "number" },
                            baz: "baz"
                        }
                    },
                    data: function() {
                        return new kendo.data.ObservableArray([]);
                    }
                });
                ok(!reader.data().length);
            });
        </script>
    </body>
</html>
