<!DOCTYPE html>
<html>
    <head>
        <title>DatePicker API</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.popup.js"></script>
        <script src="../../src/kendo.calendar.js"></script>
        <script src="../../src/kendo.datepicker.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">DatePicker API</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            kendo.ns = "kendo-";

            var DateView = kendo.DateView,
                keys = kendo.keys,
                div, input;

            QUnit.config.testTimeout = 400;
            QUnit.config.reorder = false;

            function createCalendar(options) {
                return div.kendoCalendar($.extend({ focusOnNav: false}, options)).data("kendoCalendar");
            }

            module("kendo.ui.DatePicker API", {
                setup: function() {
                    div = $("<div />").appendTo(document.body);
                    input = $("<input />").appendTo(document.body);
                },
                teardown: function() {
                    if (input.data("kendoDatePicker")) {
                        input.data("kendoDatePicker").destroy();
                    }

                    div.remove();
                    input.remove();
                }
            });

            test("click enter should raise change event if dateview is closed", function() {
                var input = $("<input />"),
                datepicker = input.kendoDatePicker().data("kendoDatePicker");

                datepicker.close();

                stub(datepicker, { _change: datepicker._change });

                input.focus().val("10/10/2000");
                datepicker._keydown({
                    currentTarget: document.createElement("input"),
                    keyCode: keys.ENTER,
                    preventDefault: $.noop
                });

                equal(datepicker.calls("_change"), 1);
            });

            test("navigate down should persist current viewedValue", function() {
                var value = new Date(2000, 10, 10, 22, 22, 22),
                    upEvent = { keyCode: keys.UP, ctrlKey: true, preventDefault: $.noop },
                    downEvent = { keyCode: keys.DOWN, ctrlKey: true, preventDefault: $.noop },
                    dv = new DateView({
                        value: value,
                        min: new Date(1999, 10, 10),
                        max: new Date(2111, 10, 10),
                        start: "month",
                        depth: "month"
                    });

                dv.calendar = createCalendar();

                dv.open();

                dv.move(upEvent);
                dv.move(upEvent);

                dv.move(downEvent);
                dv.move(downEvent);

                equal(+dv._current, +value);
            });

            //MONTH View
            test("navigate should not move selection if value is bigger than max", function() {
                var event = { keyCode: keys.RIGHT, preventDefault: $.noop },
                    date = new Date(2000, 11, 1),
                    dv = new DateView({
                        depth: "month",
                        start: "month",
                        min: new Date(1900, 10, 10),
                        value: date,
                        max: date
                    });

                dv.calendar = createCalendar();

                debugger;
                dv._calendar();
                dv.popup.open();
                dv.move(event);

                equal(+dv._current, +date);
                equal(dv.calendar._table.find(".k-state-focused").text(), date.getDate() + "");
            });

            test("navigate should not move selection if value is less than min", function() {
                var event = { keyCode: keys.LEFT, preventDefault: $.noop },
                    date = new Date(2000, 11, 1),
                    dv = new DateView({start: "month", depth: "month", value: date, min: date, max: new Date(2100, 10, 10)});

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.move(event);

                equal(+dv._current, +date);
                equal(dv.calendar._table.find(".k-state-focused").text(), date.getDate() + "");

            });

            test("navigate should focus next day in month view", function() {
                var event = { keyCode: keys.RIGHT, preventDefault: $.noop },
                    dv = new DateView({
                        start: "month",
                        depth: "month",
                        min: new Date(1999, 10, 10),
                        max: new Date(2111, 10, 10)
                    }),
                    focusedDate = new Date(dv._current);

                kendo.calendar.views[0].setDate(focusedDate, 1);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.move(event);

                equal(dv.calendar._table.find(".k-state-focused").text(), focusedDate.getDate() + "");

            });

            test("navigate should focus previous day in month view", function() {
                var event = { keyCode: keys.LEFT, preventDefault: $.noop },
                    dv = new DateView({start: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                focusedDate.setDate(focusedDate.getDate() - 1);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.move(event);

                equal(dv.calendar._table.find(".k-state-focused").text(), focusedDate.getDate() + "");
            });

            test("navigate should focus day on previous row in month view", function() {
                var event = { keyCode: keys.UP, preventDefault: $.noop },
                    dv = new DateView({start: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                focusedDate.setDate(focusedDate.getDate() - 7);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.move(event);

                equal(dv.calendar._table.find(".k-state-focused").text(), focusedDate.getDate() + "");
            });

            test("navigate should focus day on next row in month view", function() {
                var event = { keyCode: keys.DOWN, preventDefault: $.noop },
                    dv = new DateView({start: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                focusedDate.setDate(focusedDate.getDate() + 7);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.move(event);

                equal(dv.calendar._table.find(".k-state-focused").text(), focusedDate.getDate() + "");
            });

            //YEAR VIEW
            test("navigate should focus next month in year view", function() {
                var event = { keyCode: keys.RIGHT, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigateUp();

                focusedDate.setMonth(focusedDate.getMonth() + 1);

                dv.move(event);

                equal(dv.calendar._table.find(".k-state-focused").text(), "Dec");
            });

            test("navigate should focus previous month in year view", function() {
                var event = { keyCode: keys.LEFT, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigateUp();

                focusedDate.setMonth(focusedDate.getMonth() - 1);

                dv.move(event);

                equal(+dv._current, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "Oct");
            });

            test("navigate should focus month on previous row in year view", function() {
                var event = { keyCode: keys.UP, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigateUp();

                focusedDate.setMonth(focusedDate.getMonth() - 4);

                dv.move(event);

                equal(+dv._current, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "Jul");
            });

            test("navigate should focus month on next row in year view", function() {
                var event = { keyCode: keys.DOWN, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigateUp();

                focusedDate.setMonth(focusedDate.getMonth() + 4);

                dv.move(event);

                equal(+dv._current, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "Mar");
            });

            //DECADE VIEW
            test("navigate should focus next year in decade view", function() {
                var event = { keyCode: keys.RIGHT, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigate(null, "decade");

                focusedDate.setFullYear(focusedDate.getFullYear() + 1);

                dv.move(event);

                equal(+dv._current, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "2001");

            });

            test("navigate should focus previous year in decade view", function() {
                var event = { keyCode: keys.LEFT, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigate(null, "decade");

                focusedDate.setFullYear(focusedDate.getFullYear() - 1);

                dv.move(event);

                equal(+dv._current, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "1999");
                ok(!dv.calendar._table.find(".k-state-focused").hasClass("k-other-month"));
            });

            test("navigate should focus year on previous row in decade view", function() {
                var event = { keyCode: keys.UP, preventDefault: $.noop },
                    dv = new DateView({
                        depth: "month",
                        start: "month",
                        value: new Date(2000, 10, 10),
                        min: new Date(1900, 10, 10),
                        max: new Date(2111, 10, 10)
                    }),
                    focusedDate = new Date(dv._current);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigate(null, "decade");

                focusedDate.setFullYear(focusedDate.getFullYear() - 4);

                dv.move(event);

                equal(+dv._current, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "1996");
            });

            test("navigate should focus year on next row in decade view", function() {
                var event = { keyCode: keys.DOWN, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigate(null, "decade");

                focusedDate.setFullYear(focusedDate.getFullYear() + 4);

                dv.move(event);

                equal(+dv._current, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "2004");
            });

            //CENTURY VIEW
            test("navigate should focus next decade in century view", function() {
                var event = { keyCode: keys.RIGHT, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigate(null, "century");

                focusedDate.setFullYear(focusedDate.getFullYear() + 10);

                dv.move(event);

                equal(+dv._current, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "2010 - 2019");
            });

            test("navigate should focus previous decade in century view", function() {
                var event = { keyCode: keys.LEFT, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigate(null, "century");

                focusedDate.setFullYear(focusedDate.getFullYear() - 10);

                dv.move(event);

                equal(+dv._current, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "1990 - 1999");
            });

            test("navigate should focus decade on previous row in century view", function() {
                var event = { keyCode: keys.UP, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigate(null, "century");

                focusedDate.setFullYear(focusedDate.getFullYear() - 40);

                dv.move(event);

                equal(+dv._current, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "1960 - 1969");
            });

            test("navigate should focus decade on next row in century view", function() {
                var event = { keyCode: keys.DOWN, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._current);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigate(null, "century");

                focusedDate.setFullYear(focusedDate.getFullYear() + 40);

                dv.move(event);

                equal(+dv._current, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "2040 - 2049");
            });

            //Navigate through views
            test("navigate down", function() {
                var event = { keyCode: keys.DOWN, ctrlKey: true, preventDefault: $.noop },
                    dv = new DateView({
                        value: new Date(2000, 10, 10),
                        start: "month",
                        depth: "month",
                        min: new Date(1900, 10, 10),
                        max: new Date(2111, 10, 10)
                    });

                dv.calendar = createCalendar();
                stub(dv.calendar, { navigateDown: dv.calendar.navigateDown });
                dv._calendar();
                dv.popup.open();
                dv.calendar.navigateUp();

                dv.calendar._focus(dv._current);

                dv.move(event);

                equal(dv.calendar.calls("navigateDown"), 1);
            });

            test("navigate up", function() {
                var event = { keyCode: keys.UP, ctrlKey: true, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                stub(dv.calendar, "navigateUp");

                dv._calendar();
                dv.popup.open();
                dv.move(event);

                equal(dv.calendar.calls("navigateUp"), 1);
            });

            test("navigate down selects date", function() {
                var event = { keyCode: keys.DOWN, ctrlKey: true, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)}),
                    selectedDate = new Date(2000, 10, 15);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.calendar._focus(selectedDate);

                dv.move(event);

                equal(+dv.calendar.value(), +selectedDate);
            });

            test("navigate left", function() {
                var event = { keyCode: keys.LEFT, ctrlKey: true, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                dv.calendar = createCalendar();
                stub(dv.calendar, "navigateToPast");

                dv._calendar();
                dv.popup.open();
                dv.move(event);

                equal(dv.calendar.calls("navigateToPast"), 1);
            });

            test("navigate right", function() {
                var event = { keyCode: keys.RIGHT, ctrlKey: true, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                dv.calendar = createCalendar();
                stub(dv.calendar, "navigateToFuture");

                dv._calendar();
                dv.popup.open();
                dv.move(event);

                equal(dv.calendar.calls("navigateToFuture"), 1);
            });

            test("Home should focus first day of current month", function() {
                var event = { keyCode: keys.HOME, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.move(event);

                var value = dv.calendar.element.find(".k-state-focused").children(":first").attr("data-kendo-value");

                equal(value, "2000/10/1");
            });

            test("End should focus last day of current month", function() {
                var event = { keyCode: keys.END, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                dv.move(event);

                var value = dv.calendar.element.find(".k-state-focused").children(":first").attr("data-kendo-value");

                equal(value, "2000/10/30");
            });

            test("PageUp should focus same day in previous month", function() {
                var event = { keyCode: keys.PAGEUP, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();
                stub(dv.calendar, {navigateToPast: dv.calendar.navigateToPast});

                dv.move(event);

                equal(dv.calendar.calls("navigateToPast"), 1);
            });

            test("PageDown should focus same day in next month", function() {
                var event = { keyCode: keys.PAGEDOWN, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), start: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();

                stub(dv.calendar, {navigateToFuture: dv.calendar.navigateToFuture});

                dv.move(event);

                equal(dv.calendar.calls("navigateToFuture"), 1);
            });

            test("Enter should close date if select date", function() {
                var event = { keyCode: keys.ENTER, preventDefault: $.noop },
                dv = new DateView({
                    anchor: $("<input />"),
                    value: new Date(2000, 10, 10),
                    min: new Date(1900, 10, 10),
                    max: new Date(2100, 10, 10),
                    start: "month",
                    depth: "month"
                });

                dv.calendar = createCalendar();
                dv.open();

                dv.calendar._focus(dv._current);

                dv.move(event);

                ok(!dv.popup.visible());
            });

            test("Enter should focus viewedDate", function() {
                var event = { keyCode: keys.ENTER, preventDefault: $.noop },
                dv = new DateView({
                    anchor: $("<input />"),
                    value: new Date(2000, 10, 10),
                    min: new Date(1900, 10, 10),
                    max: new Date(2100, 10, 10),
                    start: "month",
                    depth: "month"
                });

                dv.calendar = createCalendar();
                dv.open();

                dv.calendar.navigate(new Date(2000, 10, 10), "year");
                dv.calendar._focus(dv._current);
                dv.move(event);

                ok(dv.popup.visible());
                equal(dv.calendar._table.find(".k-state-focused").length, 1);
            });

            test("Enter should select date", function() {
                var called, event = { keyCode: keys.ENTER, preventDefault: $.noop },
                dv = new DateView({
                    anchor: $("<input />"),
                    value: new Date(2000, 10, 10),
                    min: new Date(1900, 10, 10),
                    max: new Date(2100, 10, 10),
                    start: "month",
                    depth: "month"
                }),
                focused = new Date(2000, 10, 11);

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();

                stub(dv.calendar, {navigateDown: dv.calendar.navigateDown});

                dv.calendar._focus(focused);
                dv.move(event);

                equal(+dv.calendar.args("navigateDown")[0], +focused);
            });

            test("Enter should navigate down", function() {
                var event = { keyCode: keys.ENTER, preventDefault: $.noop },
                    dv = new DateView({
                        anchor: $("<input />"),
                        value: new Date(2010, 10, 10),
                        min: new Date(1900, 10, 10),
                        max: new Date(2100, 10, 10),
                        start: "month",
                        depth: "month"
                    });

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();

                stub(dv.calendar, {navigateDown: dv.calendar.navigateDown});

                dv.calendar.navigateUp();
                dv.calendar._focus(dv._current);

                dv.move(event);

                equal(dv.calendar.calls("navigateDown"), 1);
            });

            test("Esc should close dateView", function() {
                var event = { keyCode: keys.ESC, preventDefault: $.noop },
                dv = new DateView({
                    anchor: $("<input />"),
                    value: new Date(2000, 10, 10),
                    min: new Date(1900, 10, 10),
                    max: new Date(2100, 10, 10),
                    start: "month",
                    depth: "month"
                });

                dv.calendar = createCalendar();
                dv._calendar();
                dv.popup.open();

                stub(dv.popup, "close");

                dv.move(event);

                equal(dv.popup.calls("close"), 1);
            });

            test("type invalide date does not clear input", function() {
                var input = $("<input />"),
                    datepicker = input.kendoDatePicker({value: new Date()}).data("kendoDatePicker"),
                    value = "invalid date";

                input.focus().val(value).blur();

                equal(input.val(), value);
                equal(datepicker.value(), null);
            });

            test("click on selected date should close the dateView", 1, function() {
                var dv = new DateView({
                    min: new Date(1800, 1, 1),
                    max: new Date(2800, 1, 1),
                    start: "month",
                    depth: "month",
                    anchor: $("<input />"),
                    clearBlurTimeout: $.noop,
                    close: function() {
                        start();
                        ok(true);
                    }
                });

                dv.calendar = createCalendar();
                dv.value(new Date());
                dv.popup.open();
                dv.open();

                dv.calendar
                  .element
                  .find(".k-state-selected")
                  .click();
            });

            test("Alt + Down should open the calendar", function() {
                var input = $("<input />"),
                    event = { type: "keydown", keyCode: keys.DOWN, altKey: true, preventDefault: $.noop },
                    datepicker = input.kendoDatePicker().data("kendoDatePicker");

                stub(datepicker.dateView, "open");

                input.trigger(event);

                equal(datepicker.dateView.calls("open"), 1);
            });

            test("Alt + UP should close the calendar", function() {
                var input = $("<input />"),
                    event = { type: "keydown", keyCode: keys.UP, altKey: true, preventDefault: $.noop },
                    datepicker = input.kendoDatePicker().data("kendoDatePicker");

                stub(datepicker.dateView, "close");

                input.trigger(event);

                equal(datepicker.dateView.calls("close"), 1);
            });

            test("DatePicker does not update the input if the entered value is the same but in diff format", function() {
                var today = new Date(),
                    datepicker = input.kendoDatePicker({
                        format: "dd MMM yyyy",
                        parseFormats: ["yyyy/MM/dd"],
                        value: kendo.toString(today, "dd MMM yyyy")
                    }).data("kendoDatePicker"),
                    todayDiffFormat = kendo.toString(today, "yyyy/MM/dd");

                input.val(todayDiffFormat);

                //simulate change
                datepicker._change(input.val());

                equal(input.val(), kendo.toString(today, "dd MMM yyyy"));
            });
        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
